<%- include('partials/header', { title: 'Checkout', cssFile: 'checkout.css' }) %>

<% if (user && user.role === 'admin') { %>
    <%- include('partials/admin_sidebar') %>
<% } %>

<div class="container mx-auto mt-4">
    <h2 class="text-center text-3xl font-bold">Checkout</h2>

    <% if (!user) { %>
    <!-- If user is not logged in -->
    <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded relative text-center mt-4" role="alert">
        You need to log in to complete your purchase. Please <a href="/login" class="text-blue-500 font-semibold">log in</a> or <a href="/register" class="text-blue-500 font-semibold">register</a> to continue.
    </div>
    <% } else { %>
    <!-- If user is logged in, show their information and allow them to confirm their order -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mt-6">
        <div class="md:col-span-2" id="cart-items">
            <!-- Cart items will be inserted here by JavaScript -->
        </div>
        <div class="bg-white shadow-lg rounded-lg p-6">
            <h5 class="text-lg font-bold mb-4">Customer Information</h5>
            <p class="mb-2"><strong>First Name:</strong> <%= user.firstName %></p>
            <p class="mb-2"><strong>Last Name:</strong> <%= user.lastName %></p>
            <p class="mb-2"><strong>Phone:</strong> <%= user.phone %></p>
            <p class="mb-2"><strong>Address:</strong> <%= user.address %></p>
            <p class="mb-2"><strong>Email:</strong> <%= user.email %></p>
            
            <h4 class="text-xl font-bold mt-6">Order Summary</h4>
            <hr class="my-4">
            <div class="flex justify-between mb-2">
                <p class="text-gray-600">Subtotal:</p>
                <p id="subtotal" class="font-semibold">$0.00</p>
            </div>
            <div class="flex justify-between mb-2">
                <p class="text-gray-600">Taxes:</p>
                <p id="taxes" class="font-semibold">$0.00</p>
            </div>
            <div class="flex justify-between mb-2">
                <p class="text-gray-600">Shipping:</p>
                <p id="shipping" class="font-semibold">$0.00</p>
            </div>
            <hr class="my-4">
            <div class="flex justify-between mb-4">
                <h5 class="font-bold">Total:</h5>
                <h5 id="total" class="font-bold">$0.00</h5>
            </div>
            <form id="checkoutForm" action="/confirmOrder" method="POST" class="mt-4">
                <input type="hidden" name="cartData" id="cartData">
                <input type="hidden" name="subtotal" id="subtotalInput">
                <input type="hidden" name="taxes" id="taxesInput">
                <input type="hidden" name="shipping" id="shippingInput">
                <input type="hidden" name="total" id="totalInput">
                <input type="hidden" name="userId" value="<%= user.id %>">
                <button type="submit" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md shadow-md hover:bg-blue-600 transition-all duration-300">Confirm and Place Order</button>
            </form>
        </div>
    </div>

    <!-- Order confirmation message -->
    <div class="mt-4" id="order-confirmation-message" style="display: none;">
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative text-center">
            Your order has been successfully placed!
        </div>
    </div>
    <% } %>
</div>

<%- include('partials/footer') %>

<script>
    let currentUserId = '<%= user.id %>';

    let storedCartData = JSON.parse(localStorage.getItem('cartData')) || {};
    let cart = storedCartData.cart || {};
    let storedUserId = storedCartData.userId;

    if (storedUserId !== currentUserId) {
        cart = {};
        localStorage.setItem('cartData', JSON.stringify({ userId: currentUserId, cart }));
    }

    function updateCartDisplay() {
        const cartItemsContainer = document.getElementById('cart-items');
        cartItemsContainer.innerHTML = '';  // Clear previous cart items

        let subtotal = 0;
        const taxRate = 0.1;  // 10% tax rate
        const shippingCost = 5.99;  // Flat shipping cost

        if (cart) {
            for (const [id, product] of Object.entries(cart)) {
                const itemTotal = product.price * product.quantity;
                subtotal += itemTotal;

                const cartItemRow = `
                    <div class="cart-item mb-6 p-4 bg-white rounded-lg shadow-sm" style="box-shadow: 8px 8px 15px rgba(0, 0, 0, 0.1), -8px -8px 15px rgba(255, 255, 255, 0.7);">
                        <div class="flex items-center space-x-6">
                            <div class="w-24">
                                <img src="https://via.placeholder.com/150" class="w-full h-auto rounded-lg" alt="${product.name}">
                            </div>
                            <div class="flex-1">
                                <h5 class="text-lg font-bold text-gray-800">${product.name}</h5>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-gray-600">Quantity: ${product.quantity}</span>
                                    <p class="text-sm text-gray-600">$${product.price.toFixed(2)}</p>
                                    <p class="text-sm text-gray-600">$${itemTotal.toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                cartItemsContainer.insertAdjacentHTML('beforeend', cartItemRow);
            }
        }

        const taxes = +(subtotal * taxRate).toFixed(2);
        const total = +(subtotal + taxes + shippingCost).toFixed(2);

        document.getElementById('subtotal').innerText = `$${subtotal.toFixed(2)}`;
        document.getElementById('taxes').innerText = `$${taxes.toFixed(2)}`;
        document.getElementById('shipping').innerText = `$${shippingCost.toFixed(2)}`;
        document.getElementById('total').innerText = `$${total.toFixed(2)}`;

        document.getElementById('cartData').value = JSON.stringify({ userId: currentUserId, cart });
        document.getElementById('subtotalInput').value = subtotal.toFixed(2);
        document.getElementById('taxesInput').value = taxes.toFixed(2);
        document.getElementById('shippingInput').value = shippingCost.toFixed(2);
        document.getElementById('totalInput').value = total.toFixed(2);
    }

    document.addEventListener('DOMContentLoaded', updateCartDisplay);

    document.getElementById('checkoutForm').addEventListener('submit', function (event) {
        event.preventDefault();
        const form = event.target;

        fetch(form.action, {
            method: form.method,
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams(new FormData(form))
        })
        .then(response => response.json())
        .then(data => {
            if (data.message === 'Order confirmed successfully') {
                window.location.href = '/thankyouforyour';
                localStorage.removeItem('cartData');  // Clear the cart after order
            }
        })
        .catch(error => console.error('Error:', error));
    });
</script>
